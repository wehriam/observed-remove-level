{"version":3,"sources":["../../src/map.js"],"names":["PQueue","EventEmitter","generateId","ObservedRemoveMap","constructor","db","entries","options","namespace","prefixLength","length","maxAge","bufferPublishing","publishTimeout","insertQueue","deleteQueue","size","readyPromise","updateSize","promises","key","value","push","set","Promise","all","processQueue","concurrency","dequeueQueue","iterator","gt","lt","values","resolve","reject","next","error","k","end","dequeue","add","_dequeue","setTimeout","publish","sync","flush","maxAgeString","Date","now","toString","padStart","clear","queue","emit","dump","pairs","pair","v","slice","deletions","id","process","skipFlush","_process","insertions","put","get","notFound","undefined","del","insertMessage","deleteMessage","getPair","delete","message","keys","forEach","callback","thisArg","bind","has","Symbol","asyncIterator","shutdown","clearTimeout","queueMicrotask","onIdle"],"mappings":"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","sourcesContent":["// @flow\n\nimport PQueue from 'p-queue';\nimport EventEmitter from 'events';\nimport generateId from './generate-id';\n\ntype Options = {\n  maxAge?:number,\n  bufferPublishing?:number,\n  namespace?: string,\n  format?: string\n};\n\n/**\n * Class representing a Observed Remove Map\n *\n * Implements all methods and iterators of the native `Map` object in addition to the following.\n * See: {@link https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map}\n */\nexport default class ObservedRemoveMap<V> extends EventEmitter {\n  declare maxAge: number;\n  declare bufferPublishing: number;\n  declare deleteQueue: Array<*>;\n  declare insertQueue: Array<*>;\n  declare publishTimeout: null | TimeoutID;\n  declare readyPromise: Promise<void>;\n  declare db: Object;\n  declare namespace: string;\n  declare prefixLength: number;\n  declare size: number;\n  declare processQueue: PQueue;\n  declare dequeueQueue: PQueue;\n\n  constructor(db:Object, entries?: Iterable<[string, V]>, options?:Options = {}) {\n    super();\n    this.db = db;\n    this.namespace = options.namespace || '';\n    this.prefixLength = this.namespace.length + 1;\n    this.maxAge = typeof options.maxAge === 'undefined' ? 5000 : options.maxAge;\n    this.bufferPublishing = typeof options.bufferPublishing === 'undefined' ? 0 : options.bufferPublishing;\n    this.publishTimeout = null;\n    this.insertQueue = [];\n    this.deleteQueue = [];\n    this.size = 0;\n    this.readyPromise = (async () => {\n      await this.updateSize();\n      const promises = [];\n      if (entries) {\n        for (const [key, value] of entries) {\n          promises.push(this.set(key, value));\n        }\n      }\n      await Promise.all(promises);\n    })();\n    this.processQueue = new PQueue({ concurrency: 1 });\n    this.dequeueQueue = new PQueue();\n  }\n\n  async updateSize() {\n    let size = 0;\n    const iterator = this.db.iterator({ gt: `${this.namespace}>`, lt: `${this.namespace}?`, values: false });\n    while (true) { // eslint-disable-line  no-constant-condition\n      const key = await new Promise((resolve, reject) => {\n        iterator.next((error:Error | void, k: string | void) => {\n          if (error) {\n            reject(error);\n          } else {\n            resolve(k);\n          }\n        });\n      });\n      if (key) {\n        size += 1;\n      } else {\n        break;\n      }\n    }\n    await new Promise((resolve, reject) => {\n      iterator.end((error:Error | void) => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve();\n        }\n      });\n    });\n    this.size = size;\n  }\n\n  dequeue() {\n    return this.dequeueQueue.add(() => this._dequeue()); // eslint-disable-line no-underscore-dangle\n  }\n\n  async _dequeue() {\n    if (this.publishTimeout) {\n      return;\n    }\n    if (this.bufferPublishing > 0) {\n      this.publishTimeout = setTimeout(() => this.dequeueQueue.add(() => this.publish()), this.bufferPublishing);\n    } else {\n      await this.publish();\n    }\n  }\n\n  async publish() {\n    this.publishTimeout = null;\n    const insertQueue = this.insertQueue;\n    const deleteQueue = this.deleteQueue;\n    this.insertQueue = [];\n    this.deleteQueue = [];\n    await this.sync([insertQueue, deleteQueue]);\n  }\n\n  async flush():Promise<void> {\n    const maxAgeString = (Date.now() - this.maxAge).toString(36).padStart(9, '0');\n    await this.db.clear({ gt: `${this.namespace}<`, lt: `${this.namespace}<${maxAgeString}` });\n  }\n\n  /**\n   * Emit a 'publish' event containing a specified queue or all of the set's insertions and deletions.\n   * @param {Array<Array<any>>} queue - Array of insertions and deletions\n   * @return {void}\n   */\n  async sync(queue?: [Array<*>, Array<*>]) {\n    if (queue) {\n      this.emit('publish', queue);\n    } else {\n      this.emit('publish', await this.dump());\n    }\n  }\n\n  async pairs():Promise<Array<[string, [string, V]]>> {\n    const pairs:Array<[string, [string, V]]> = [];\n    const iterator = this.db.iterator({ gt: `${this.namespace}>`, lt: `${this.namespace}?` });\n    while (true) { // eslint-disable-line  no-constant-condition\n      const [key, pair] = await new Promise((resolve, reject) => {\n        iterator.next((error:Error | void, k: string | void, v: [string, V] | void) => {\n          if (error) {\n            reject(error);\n          } else {\n            resolve([k, v]);\n          }\n        });\n      });\n      if (key && pair) {\n        pairs.push([key.slice(this.prefixLength), pair]);\n      } else {\n        break;\n      }\n    }\n    await new Promise((resolve, reject) => {\n      iterator.end((error:Error | void) => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve();\n        }\n      });\n    });\n    return pairs;\n  }\n\n  async deletions():Promise<Array<[string, string]>> {\n    const deletions = [];\n    const iterator = this.db.iterator({ gt: `${this.namespace}<`, lt: `${this.namespace}=` });\n    while (true) { // eslint-disable-line  no-constant-condition\n      const [id, key] = await new Promise((resolve, reject) => {\n        iterator.next((error:Error | void, k: string | void, v: string | void) => {\n          if (error) {\n            reject(error);\n          } else {\n            resolve([k, v]);\n          }\n        });\n      });\n      if (id && key) {\n        deletions.push([id.slice(this.prefixLength), key]);\n      } else {\n        break;\n      }\n    }\n    await new Promise((resolve, reject) => {\n      iterator.end((error:Error | void) => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve();\n        }\n      });\n    });\n    return deletions;\n  }\n\n  /**\n   * Return an array containing all of the map's insertions and deletions.\n   * @return {[Array<*>, Array<*>]>}\n   */\n  async dump():Promise<[Array<*>, Array<*>]> {\n    return Promise.all([this.pairs(), this.deletions()]);\n  }\n\n  process(queue:[Array<*>, Array<*>], skipFlush?: boolean = false) {\n    return this.processQueue.add(() => this._process(queue, skipFlush)); // eslint-disable-line no-underscore-dangle\n  }\n\n  async _process(queue:[Array<*>, Array<*>], skipFlush?: boolean = false) {\n    const [insertions, deletions] = queue;\n    for (const [id, key] of deletions) {\n      await this.db.put(`${this.namespace}<${id}`, key);\n    }\n    for (const [key, [id, value]] of insertions) {\n      try {\n        await this.db.get(`${this.namespace}<${id}`);\n        continue;\n      } catch (error) {\n        if (!error.notFound) {\n          throw error;\n        }\n      }\n      try {\n        const pair = await this.db.get(`${this.namespace}>${key}`);\n        if (pair[0] < id) {\n          if (typeof value === 'undefined') {\n            await this.db.put(`${this.namespace}>${key}`, [id]);\n          } else {\n            await this.db.put(`${this.namespace}>${key}`, [id, value]);\n          }\n          this.emit('set', key, value, pair[1]);\n        } else if (pair[0] === id) {\n          this.emit('affirm', key, value, pair[1]);\n        }\n      } catch (error) {\n        if (!error.notFound) {\n          throw error;\n        }\n        if (typeof value === 'undefined') {\n          await this.db.put(`${this.namespace}>${key}`, [id]);\n        } else {\n          await this.db.put(`${this.namespace}>${key}`, [id, value]);\n        }\n        this.size += 1;\n        this.emit('set', key, value, undefined);\n      }\n    }\n    for (const [id, key] of deletions) {\n      try {\n        const pair = await this.db.get(`${this.namespace}>${key}`);\n        if (pair[0] === id) {\n          await this.db.del(`${this.namespace}>${key}`);\n          this.size -= 1;\n          this.emit('delete', key, pair[1]);\n        }\n      } catch (error) {\n        if (!error.notFound) {\n          throw error;\n        }\n      }\n    }\n    if (!skipFlush) {\n      await this.flush();\n    }\n  }\n\n  async set(key:string, value:V, id?: string = generateId()): Promise<void> {\n    const insertMessage = typeof value === 'undefined' ? [key, [id]] : [key, [id, value]];\n    try {\n      const pair = await this.db.get(`${this.namespace}>${key}`);\n      const deleteMessage = [pair[0], key];\n      await this.process([[insertMessage], [deleteMessage]], true);\n      this.deleteQueue.push(deleteMessage);\n    } catch (error) {\n      if (error.notFound) {\n        await this.process([[insertMessage], []], true);\n      } else {\n        throw error;\n      }\n    }\n    this.insertQueue.push(insertMessage);\n    await this.dequeue();\n  }\n\n  async getPair(key:string): Promise<[string, V] | void> { // eslint-disable-line consistent-return\n    try {\n      const pair = await this.db.get(`${this.namespace}>${key}`);\n      return pair;\n    } catch (error) {\n      if (error.notFound) {\n        return; // eslint-disable-line consistent-return\n      }\n      throw error;\n    }\n  }\n\n  async get(key:string): Promise<V | void> { // eslint-disable-line consistent-return\n    try {\n      const pair = await this.db.get(`${this.namespace}>${key}`);\n      return pair[1];\n    } catch (error) {\n      if (error.notFound) {\n        return; // eslint-disable-line consistent-return\n      }\n      throw error;\n    }\n  }\n\n  async delete(key:string): Promise<void> {\n    try {\n      const pair = await this.db.get(`${this.namespace}>${key}`);\n      const message = [pair[0], key];\n      await this.process([[], [message]], true);\n      this.deleteQueue.push(message);\n      await this.dequeue();\n    } catch (error) {\n      if (error.notFound) {\n        return;\n      }\n      throw error;\n    }\n  }\n\n  async clear(): Promise<void> {\n    for await (const key of this.keys()) {\n      await this.delete(key);\n    }\n  }\n\n  async forEach(callback:Function, thisArg?:any):Promise<void> {\n    if (thisArg) {\n      for await (const [key, value] of this.entries()) {\n        callback.bind(thisArg)(value, key, this);\n      }\n    } else {\n      for await (const [key, value] of this.entries()) {\n        callback(value, key, this);\n      }\n    }\n  }\n\n  async has(key:string): Promise<boolean> {\n    return !!(await this.get(key));\n  }\n\n  async* keys():AsyncGenerator<string, void, void> {\n    const iterator = this.db.iterator({ gt: `${this.namespace}>`, lt: `${this.namespace}?`, values: false });\n    while (true) {\n      const key = await new Promise((resolve, reject) => {\n        iterator.next((error:Error | void, k: string | void) => {\n          if (error) {\n            reject(error);\n          } else {\n            resolve(k);\n          }\n        });\n      });\n      if (key) {\n        yield key.slice(this.prefixLength);\n      } else {\n        break;\n      }\n    }\n    await new Promise((resolve, reject) => {\n      iterator.end((error:Error | void) => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve();\n        }\n      });\n    });\n  }\n\n  async* entries():AsyncGenerator<[string, V], void, void> {\n    const iterator = this.db.iterator({ gt: `${this.namespace}>`, lt: `${this.namespace}?` });\n    while (true) {\n      const [key, pair] = await new Promise((resolve, reject) => {\n        iterator.next((error:Error | void, k: string | void, v: [string, V] | void) => {\n          if (error) {\n            reject(error);\n          } else {\n            resolve([k, v]);\n          }\n        });\n      });\n      if (key && pair) {\n        yield [key.slice(this.prefixLength), pair[1]];\n      } else {\n        break;\n      }\n    }\n    await new Promise((resolve, reject) => {\n      iterator.end((error:Error | void) => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve();\n        }\n      });\n    });\n  }\n\n  /* :: @@asyncIterator(): AsyncIterator<[string, V]> { return ({}: any); } */\n  // $FlowFixMe: computed property\n  [Symbol.asyncIterator]() {\n    return this.entries();\n  }\n\n  async* values():AsyncGenerator<V, void, void> {\n    const iterator = this.db.iterator({ gt: `${this.namespace}>`, lt: `${this.namespace}?`, keys: false });\n    while (true) {\n      const pair = await new Promise((resolve, reject) => {\n        iterator.next((error:Error | void, k: void, v: [string, V] | void) => {\n          if (error) {\n            reject(error);\n          } else {\n            resolve(v);\n          }\n        });\n      });\n      if (pair) {\n        yield pair[1];\n      } else {\n        break;\n      }\n    }\n    await new Promise((resolve, reject) => {\n      iterator.end((error:Error | void) => {\n        if (error) {\n          reject(error);\n        } else {\n          resolve();\n        }\n      });\n    });\n  }\n\n  async shutdown() {\n    clearTimeout(this.publishTimeout);\n    // $FlowFixMe\n    await new Promise((resolve) => queueMicrotask(resolve));\n    await Promise.all([\n      this.processQueue.onIdle(),\n      this.dequeueQueue.onIdle(),\n    ]);\n  }\n}\n"],"file":"map.js"}